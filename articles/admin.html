<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Administración</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body { background-color: #1a1a1a; color: #f0f0f0; }
        .container { max-width: 900px; }
        label { font-weight: bold; color: #e0e0e0; }
        input, textarea, button {
            background-color: #2a2a2a;
            border: 1px solid #444;
            color: #f0f0f0;
            padding: 8px;
            border-radius: 4px;
            width: 100%;
        }
        textarea { min-height: 200px; font-family: monospace; }
        .output-box {
            background-color: #111;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        .gold-text { color: #D4AF37; }
    </style>
</head>
<body class="p-8">

    <div id="auth-overlay" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl text-center">
            <h2 class="text-2xl font-bold mb-4 gold-text">Acceso Restringido</h2>
            <p class="text-gray-300 mb-4">Por favor, introduce la contraseña para continuar.</p>
            <input type="password" id="password" class="text-center">
            <button onclick="checkPassword()" class="mt-4 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded">
                Acceder
            </button>
        </div>
    </div>

    <div id="main-content" class="container mx-auto hidden">
        <h1 class="text-4xl font-bold mb-6 gold-text">Panel para Agregar Nuevos Artículos</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="title" class="block mb-2">Título del Artículo</label>
                <input type="text" id="title">
            </div>
            <div>
                <label for="video_id" class="block mb-2">ID del Video de YouTube (Opcional)</label>
                <input type="text" id="video_id">
            </div>
        </div>

        <div class="mt-4">
            <label for="description" class="block mb-2">Descripción (para la tarjeta del index)</label>
            <textarea id="description" rows="3"></textarea>
        </div>

        <div class="mt-4">
            <label for="article_html" class="block mb-2">Contenido HTML del Artículo (de genspark)</label>
            <textarea id="article_html"></textarea>
        </div>

        <button onclick="generateFiles()" class="mt-6 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded text-xl">
            Generar Códigos
        </button>

        <div id="outputs" class="hidden mt-8">
            <div class="output-box">
                <h2 class="text-2xl font-bold mb-3 gold-text">1. Guardar Nuevo Artículo</h2>
                <p class="text-gray-400 mb-2">Copia este código y guárdalo en un nuevo archivo dentro de la carpeta `articles/`. Nómbralo usando el título, por ejemplo: `nombre-del-articulo.html`.</p>
                <textarea id="output_article_html" readonly></textarea>
            </div>

            <div class="output-box">
                <h2 class="text-2xl font-bold mb-3 gold-text">2. Actualizar `index.html`</h2>
                <p class="text-gray-400 mb-2">Copia TODO este código y reemplaza el contenido completo de tu archivo `index.html`.</p>
                <textarea id="output_index_html" readonly></textarea>
            </div>
        </div>
    </div>

    <script>
        // --- Plantillas y Lógica ---

        function checkPassword() {
            // CONTRASEÑA: Puedes cambiar "terapia" por la que prefieras.
            const pass = "terapia";
            if (document.getElementById('password').value === pass) {
                document.getElementById('auth-overlay').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
            } else {
                alert('Contraseña incorrecta.');
            }
        }

        function getTodayDate() {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function generateArticleHTML(title, content) {
            return `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title} - Terapia Liberal</title>
    <link href="../css/article-styles.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body class="bg-gray-900 text-white">
    <div class="container mx-auto px-4 py-8">
        <a href="../index.html" class="text-yellow-400 hover:text-yellow-500 mb-4 inline-block">&larr; Volver a la Biblioteca</a>
        <div class="bg-gray-800 rounded-lg shadow-lg p-8">
            <h1 class="text-4xl font-bold mb-6 text-yellow-400">${title}</h1>
            <div class="prose prose-invert max-w-none">
                ${content}
            </div>
        </div>
    </div>
</body>
</html>`;
        }

        function generateCardHTML(title, description, video_id, date, articleHref) {
            let mediaHtml = '';
            let videoLink = '';

            if (video_id) {
                const urlVideo = `https://youtu.be/${video_id}`;
                mediaHtml = `
                <div class="video-thumbnail" onclick="window.open('${urlVideo}', '_blank')">
                    <img src="https://img.youtube.com/vi/${video_id}/maxresdefault.jpg" alt="${title}">
                    <div class="play-button"><i class="fas fa-play"></i></div>
                </div>`;
                videoLink = `<a href="${urlVideo}" target="_blank" class="btn-gradient text-sm">Ver Video</a>`;
            } else {
                mediaHtml = '';
                videoLink = '';
            }

            const cleanTitle = title.replace(/\s+/g, ' ').trim();
            const cleanDescription = description.replace(/\s+/g, ' ').trim();
            const cleanDate = date.replace(/\s+/g, ' ').trim();

            return `
            <div class="section-bg rounded-2xl p-6 flex flex-col h-full">
                ${mediaHtml}
                <div class="flex-grow flex flex-col">
                    <div class="date-badge mb-3">${cleanDate}</div>
                    <h4 class="text-xl font-bold mb-3 gold-text">${cleanTitle}</h4>
                    <p class="text-gray-300 mb-4 flex-grow">${cleanDescription}</p>
                    <div class="flex gap-3 mt-auto">
                        <a href="${articleHref}" class="btn-gradient text-sm">Ver Análisis</a>
                        ${videoLink}
                    </div>
                </div>
            </div>`;
        }

        function generateFeaturedMediaHTML(title, video_id) {
            if (video_id) {
                const urlVideo = `https://youtu.be/${video_id}`;
                return `
            <div class="video-thumbnail-featured" onclick="window.open('${urlVideo}', '_blank')">
                <img src="https://img.youtube.com/vi/${video_id}/maxresdefault.jpg" alt="${title}">
                <div class="play-button-featured"><i class="fas fa-play"></i></div>
            </div>`;
            } else {
                return '';
            }
        }

        function generateFeaturedTextHTML(title, description, newArticleFileName, video_id) {
            let videoLinkHtml = '';
            if (video_id) {
                videoLinkHtml = `<a href="https://youtu.be/${video_id}" target="_blank" class="btn-gradient">Ver Video</a>`;
            }
            return `
        <div class="date-badge mb-4">${getTodayDate()} ÚLTIMO ANÁLISIS</div>
        <h4 class="text-2xl font-bold mb-4 gold-text">${title}</h4>
        <p class="text-gray-300 mb-6 flex-grow">${description}</p>
        <div class="flex gap-4 mt-auto">
            <a href="${newArticleFileName}" class="btn-gradient">Ver Análisis Completo</a>
            ${videoLinkHtml}
        </div>`;
        }

        async function generateFiles() {
            const newTitle = document.getElementById('title').value;
            const newVideoId = document.getElementById('video_id').value;
            const newDescription = document.getElementById('description').value;
            const newArticleHtml = document.getElementById('article_html').value;

            if (!newTitle || !newDescription || !newArticleHtml) {
                alert('Por favor, completa todos los campos requeridos.');
                return;
            }

            const newArticleFileName = "articles/" + newTitle.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '') + '.html';
            const newArticleContent = generateArticleHTML(newTitle, newArticleHtml);
            document.getElementById('output_article_html').value = newArticleContent;

            try {
                const response = await fetch('../index.html');
                if (!response.ok) throw new Error('No se pudo cargar index.html');
                const indexContent = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(indexContent, 'text/html');

                const featuredH3 = Array.from(doc.querySelectorAll('h3')).find(el => el.textContent.includes('Análisis Destacado'));
                if (!featuredH3) throw new Error('Sección "Análisis Destacado" no encontrada.');
                const featuredContainer = featuredH3.closest('section');

                const oldTitle = featuredContainer.querySelector('h4').textContent;
                const oldDescription = featuredContainer.querySelector('p').textContent;
                const oldArticleLink = featuredContainer.querySelector('a[href^="articles/"]');
                const oldArticleHref = oldArticleLink ? oldArticleLink.getAttribute('href') : '';
                const oldVideoLink = featuredContainer.querySelector('a[href^="https://youtu.be/"]');
                const oldVideoId = oldVideoLink ? new URL(oldVideoLink.href).pathname.substring(1) : '';
                const oldDateBadge = featuredContainer.querySelector('.date-badge');
                const oldDate = oldDateBadge ? oldDateBadge.textContent.replace('ÚLTIMO ANÁLISIS', 'ANÁLISIS PREVIO') : getTodayDate() + ' ANÁLISIS PREVIO';

                if (oldArticleHref) {
                    const grid = doc.getElementById('grid-analisis');
                    if (grid) {
                        const alreadyExists = grid.querySelector(`a[href="${oldArticleHref}"]`);
                        if (!alreadyExists) {
                            const oldFeaturedCardHTML = generateCardHTML(oldTitle, oldDescription, oldVideoId, oldDate, oldArticleHref);
                            grid.insertAdjacentHTML('afterbegin', oldFeaturedCardHTML);
                        } else {
                            console.log('El artículo anterior ya estaba en la grilla. No se duplicará.');
                        }
                    } else {
                        console.warn('Grid no encontrado.');
                    }
                }

                const featuredMediaDiv = featuredContainer.querySelector('.lg\:w-1\/2:first-child');
                const featuredTextDiv = featuredContainer.querySelector('.lg\:w-1\/2:last-child');

                if (featuredMediaDiv) {
                    featuredMediaDiv.innerHTML = generateFeaturedMediaHTML(newTitle, newVideoId);
                }
                if (featuredTextDiv) {
                    featuredTextDiv.innerHTML = generateFeaturedTextHTML(newTitle, newDescription, newArticleFileName, newVideoId);
                }

                const finalHtml = "<!DOCTYPE html>\n" + doc.documentElement.outerHTML;
                document.getElementById('output_index_html').value = finalHtml;

            } catch (error) {
                alert('Error al procesar index.html: ' + error.message);
                return;
            }

            document.getElementById('outputs').style.display = 'block';
            window.scrollTo(0, document.body.scrollHeight);
        }
    </script>

        async function generateFiles() {
            const newTitle = document.getElementById('title').value;
            const newVideoId = document.getElementById('video_id').value;
            const newDescription = document.getElementById('description').value;
            const newArticleHtml = document.getElementById('article_html').value;

            if (!newTitle || !newDescription || !newArticleHtml) {
                alert('Por favor, completa todos los campos requeridos.');
                return;
            }

            // --- 1. Generar HTML para el nuevo archivo de artículo ---
            const newArticleContent = generateArticleHTML(newTitle, newArticleHtml);
            document.getElementById('output_article_html').value = newArticleContent;
            const newArticleFileName = "articles/" + newTitle.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '') + '.html';

            // --- 2. Generar el nuevo index.html con la lógica de rotación ---
            try {
                const response = await fetch('../index.html');
                if (!response.ok) {
                    throw new Error('No se pudo cargar el index.html. Asegúrate de que el panel admin.html está en la carpeta 'articles/' y que index.html está en la raíz.');
                }
                const indexContent = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(indexContent, 'text/html');

                // --- Paso A: Encontrar la sección de destacados ---
                const featuredH3 = Array.from(doc.querySelectorAll('h3')).find(el => el.textContent.includes('Análisis Destacado'));
                if (!featuredH3) throw new Error('No se pudo encontrar la sección "Análisis Destacado".');
                const featuredContainer = featuredH3.closest('section');
                if (!featuredContainer) throw new Error('No se pudo encontrar el contenedor de la sección de destacados.');

                // --- Paso B: Extraer datos del ANTIGUO artículo destacado ---
                const oldTitle = featuredContainer.querySelector('h4').textContent;
                const oldDescription = featuredContainer.querySelector('p').textContent;
                const oldArticleLink = featuredContainer.querySelector('a[href^="articles/"]');
                const oldArticleHref = oldArticleLink ? oldArticleLink.getAttribute('href') : '';
                const oldVideoLink = featuredContainer.querySelector('a[href^="https://youtu.be/"]');
                const oldVideoId = oldVideoLink ? new URL(oldVideoLink.href).pathname.substring(1) : '';
                const oldDateBadge = featuredContainer.querySelector('.date-badge');
                const oldDate = oldDateBadge ? oldDateBadge.textContent.replace('ÚLTIMO ANÁLISIS', 'ANÁLISIS PREVIO') : getTodayDate() + ' ANÁLISIS PREVIO';

                // --- Paso C: Crear una tarjeta de grilla con los datos del antiguo destacado ---
                if (oldArticleHref) {
                    const oldFeaturedCardHTML = generateCardHTML(oldTitle, oldDescription, oldVideoId, oldDate, oldArticleHref);
                    const grid = doc.getElementById('grid-analisis');
                    if (grid) {
                        grid.insertAdjacentHTML('afterbegin', oldFeaturedCardHTML);
                    } else {
                        console.warn('Grid con id "grid-analisis" no encontrado. No se pudo degradar el artículo destacado anterior.');
                    }
                }

                // --- Paso D: Actualizar la sección de destacados con los datos del NUEVO artículo ---
                featuredContainer.querySelector('h4').textContent = newTitle;
                featuredContainer.querySelector('p').textContent = newDescription;
                if (oldDateBadge) oldDateBadge.textContent = getTodayDate() + ' ÚLTIMO ANÁLISIS';

                const featuredImg = featuredContainer.querySelector('img');
                if (featuredImg) {
                    featuredImg.src = `https://img.youtube.com/vi/${newVideoId}/maxresdefault.jpg`;
                    featuredImg.alt = newTitle;
                }

                const featuredVideoContainer = featuredContainer.querySelector('.video-thumbnail-featured');
                if (featuredVideoContainer) featuredVideoContainer.setAttribute('onclick', `window.open('https://youtu.be/${newVideoId}', '_blank')`);

                const links = featuredContainer.querySelectorAll('a.btn-gradient');
                if (links.length >= 2) {
                    links[0].href = newArticleFileName; // "Ver Análisis Completo"
                    links[1].href = `https://youtu.be/${newVideoId}`; // "Ver Video"
                }

                // --- Paso E: Serializar y mostrar el HTML final ---
                const finalHtml = "<!DOCTYPE html>\n" + doc.documentElement.outerHTML;
                document.getElementById('output_index_html').value = finalHtml;

            } catch (error) {
                alert('Error al procesar index.html: ' + error.message);
                return;
            }

            document.getElementById('outputs').style.display = 'block';
            window.scrollTo(0, document.body.scrollHeight);
        }
    </script>
</body>
</html>